<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${fileName != null ? fileName : 'æ–‡ä»¶é¢„è§ˆ'} + ' - Mini Git Server'">æ–‡ä»¶é¢„è§ˆ - Mini Git Server</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pptxjs@2.12.0/dist/pptxjs.min.css">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #2c3e50;
        }
        .header {
            background: #2c3e50;
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header a {
            color: #fff;
            text-decoration: none;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem 3rem;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 1.75rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .card h2 {
            margin-top: 0;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 0.5rem 1rem;
        }
        .info-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        .info-value {
            font-weight: 600;
            word-break: break-all;
        }
        .actions {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: #3498db;
            color: #fff;
            padding: 0.6rem 1.3rem;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .btn.secondary {
            background: #95a5a6;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.secondary:hover {
            background: #7f8c8d;
        }
        .preview-card {
            min-height: 360px;
        }
        pre {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.95rem;
            line-height: 1.55;
        }
        .code-block {
            font-family: "Fira Code", "Consolas", "Monaco", monospace;
        }
        .markdown-body {
            font-size: 1rem;
            line-height: 1.7;
        }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 0.35rem;
        }
        .markdown-body pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }
        .preview-placeholder {
            text-align: center;
            color: #7f8c8d;
            padding: 2rem 1rem;
        }
        .image-preview {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .pdf-frame {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px #ecf0f1;
        }
        .docx-wrapper {
            background: #ffffff;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px #e0e6ed;
        }
        .excel-container {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .excel-container table {
            border-collapse: collapse;
            width: 100%;
        }
        .excel-container th,
        .excel-container td {
            border: 1px solid #d0d7de;
            padding: 0.45rem 0.6rem;
            font-size: 0.9rem;
        }
        .excel-container th {
            background: #f4f6f8;
        }
        .alert {
            margin-top: 1rem;
            background: #fff6d5;
            color: #856404;
            padding: 0.85rem 1rem;
            border-radius: 6px;
            border: 1px solid #ffe9a8;
        }
        .preview-meta {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .office-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 260px;
            color: #7f8c8d;
            font-size: 1rem;
        }
        .office-hint {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }
    </style>
</head>
<body>
<header class="header">
    <div>
        <span>ğŸ“</span>
        <span th:text="${repoName}">repository.git</span>
    </div>
    <div>
        <a th:if="${backUrl != null}" th:href="${backUrl}" class="back-link">â† è¿”å›ä»“åº“</a>
    </div>
</header>

<div class="container">
    <div class="card">
        <h2>ğŸ“„ <span th:text="${fileName}">æ–‡ä»¶å</span></h2>
        <div class="info-grid">
            <div class="info-label">åˆ†æ”¯</div>
            <div class="info-value" th:text="${branch != null ? branch : 'é»˜è®¤åˆ†æ”¯'}">main</div>
            <div class="info-label">è·¯å¾„</div>
            <div class="info-value" th:text="${filePath}">README.md</div>
            <div class="info-label">å¤§å°</div>
            <div class="info-value" th:text="${fileSizeFormatted}">1.2 KB</div>
            <div class="info-label">ç±»å‹</div>
            <div class="info-value" th:text="${previewType}">text</div>
        </div>
        <div class="actions">
            <a th:href="${downloadUrl}" class="btn">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</a>
            <a th:href="${rawUrl}" class="btn secondary" target="_blank" rel="noopener">æŸ¥çœ‹åŸå§‹å†…å®¹</a>
        </div>
        <div class="preview-meta" th:if="${tooLargeForInline}">æç¤º: æ–‡ä»¶è¶…è¿‡ 1 MBï¼Œå·²ç¦ç”¨ç›´æ¥æ¸²æŸ“ï¼Œè¯·ä¸‹è½½æˆ–æŸ¥çœ‹åŸå§‹å†…å®¹ã€‚</div>
        <div class="preview-meta" th:if="${binaryDetected}">æç¤º: æ–‡ä»¶åŒ…å«äºŒè¿›åˆ¶å†…å®¹ï¼Œæ— æ³•ä½œä¸ºæ–‡æœ¬æ¸²æŸ“ã€‚</div>
    </div>

    <div class="card preview-card">
        <div th:if="${previewAvailable}">
            <div th:if="${inlinePreview}" th:switch="${previewType}">
                <div th:case="'text'">
                    <pre><code th:class="${highlightLanguage != null} ? 'code-block hljs ' + highlightLanguage : 'code-block hljs'" th:text="${textContent}"></code></pre>
                </div>
                <div th:case="'markdown'">
                    <article class="markdown-body" th:utext="${markdownHtml}"></article>
                </div>
                <div th:case="'image'" style="text-align:center;">
                    <img th:src="${imageData}" alt="image preview" class="image-preview"/>
                </div>
                <div th:case="'pdf'">
                    <iframe th:src="${pdfData}" class="pdf-frame"></iframe>
                </div>
                <div th:case="*">
                    <div class="preview-placeholder">æš‚ä¸æ”¯æŒè¯¥ç±»å‹çš„å†…åµŒé¢„è§ˆï¼Œè¯·ä¸‹è½½æŸ¥çœ‹ã€‚</div>
                </div>
            </div>

            <div th:if="${clientRenderOffice}">
                <div id="office-status" class="office-progress">æ­£åœ¨åŠ è½½ Office æ–‡æ¡£é¢„è§ˆ...</div>
                <div th:if="${previewType == 'word'}" id="docx-container" class="docx-wrapper" style="display:none;"></div>
                <div th:if="${previewType == 'excel'}" id="excel-container" class="excel-container" style="display:none;"></div>
                <div th:if="${previewType == 'powerpoint'}" id="ppt-container" class="docx-wrapper" style="display:none;"></div>

                <!-- é™çº§é¢„è§ˆé€‰é¡¹ -->
                <div id="office-fallback" style="display:none;" class="preview-placeholder">
                    <h3>ğŸ“„ Office æ–‡æ¡£ä¿¡æ¯</h3>
                    <p th:text="'æ–‡ä»¶å: ' + ${fileName}">æ–‡ä»¶å</p>
                    <p th:text="'æ–‡ä»¶å¤§å°: ' + ${fileSizeFormatted}">æ–‡ä»¶å¤§å°</p>
                    <p th:text="'æ–‡ä»¶ç±»å‹: ' + ${previewType}">æ–‡ä»¶ç±»å‹</p>
                    <div class="alert" style="margin-top: 1.5rem;">
                        <p><strong>ğŸ’¡ é¢„è§ˆæç¤ºï¼š</strong></p>
                        <p>â€¢ Office æ–‡æ¡£éœ€è¦ä¸“ç”¨è½¯ä»¶æ‰“å¼€ä»¥è·å¾—æœ€ä½³ä½“éªŒ</p>
                        <p>â€¢ å»ºè®®ä¸‹è½½åä½¿ç”¨ Microsoft Office æˆ– WPS Office æ‰“å¼€</p>
                        <p>â€¢ å¯¹äº Excel æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Google Sheets ç­‰åœ¨çº¿å·¥å…·</p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <a th:href="${downloadUrl}" class="btn" style="display: inline-block;">ğŸ“¥ ç«‹å³ä¸‹è½½</a>
                        <a th:href="${rawUrl}" class="btn secondary" style="display: inline-block; margin-left: 0.5rem;" target="_blank">ğŸ” æŸ¥çœ‹åŸå§‹æ–‡ä»¶</a>
                    </div>
                </div>

                <div class="office-hint">è‹¥é¢„è§ˆå¤±è´¥ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹è½½æ¨¡å¼ã€‚</div>
            </div>
        </div>
        <div th:if="${!previewAvailable}" class="preview-placeholder">
            <p>æš‚ä¸æ”¯æŒæ­¤æ–‡ä»¶ç±»å‹çš„åœ¨çº¿é¢„è§ˆã€‚</p>
            <p>ä½ ä»ç„¶å¯ä»¥é€šè¿‡ä¸Šæ–¹çš„æŒ‰é’®ä¸‹è½½æˆ–æŸ¥çœ‹åŸå§‹å†…å®¹ã€‚</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxjs@2.12.0/dist/pptxjs.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('pre code').forEach(function (block) {
            if (window.hljs) {
                window.hljs.highlightElement(block);
            }
        });
    });

    const clientRenderOffice = /*[[${clientRenderOffice}]]*/ false;
    const rawUrl = /*[[${rawUrl}]]*/ '';
    const previewType = /*[[${previewType}]]*/ 'binary';

    function showFallback() {
        const statusEl = document.getElementById('office-status');
        const fallbackEl = document.getElementById('office-fallback');
        if (statusEl) statusEl.style.display = 'none';
        if (fallbackEl) fallbackEl.style.display = 'block';
    }

    function hideStatusShowContainer(containerId) {
        const statusEl = document.getElementById('office-status');
        const containerEl = document.getElementById(containerId);
        if (statusEl) statusEl.style.display = 'none';
        if (containerEl) containerEl.style.display = 'block';
    }

    if (clientRenderOffice && rawUrl) {
        // æ£€æŸ¥æ‰€éœ€çš„åº“æ˜¯å¦å·²åŠ è½½
        let libraryCheckPassed = false;
        if (previewType === 'word' && window.docx && typeof window.docx.renderAsync === 'function') {
            libraryCheckPassed = true;
        } else if (previewType === 'excel' && window.XLSX && typeof window.XLSX.read === 'function') {
            libraryCheckPassed = true;
        } else if (previewType === 'powerpoint' && window.PPTX && typeof window.PPTX.load === 'function') {
            libraryCheckPassed = true;
        }

        if (!libraryCheckPassed) {
            console.warn('Office é¢„è§ˆåº“æœªæ­£ç¡®åŠ è½½ï¼Œåˆ‡æ¢åˆ°é™çº§æ¨¡å¼');
            showFallback();
            return;
        }

        fetch(rawUrl)
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': æ— æ³•åŠ è½½æ–‡ä»¶');
                }
                return response.arrayBuffer();
            })
            .then(function (buffer) {
                if (!buffer || buffer.byteLength === 0) {
                    throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                }

                try {
                    if (previewType === 'word') {
                        const container = document.getElementById('docx-container');
                        if (!container) {
                            throw new Error('é¢„è§ˆå®¹å™¨ä¸å­˜åœ¨');
                        }

                        window.docx.renderAsync(buffer, container, null, {
                            debug: false,
                            experimental: true
                        }).then(function () {
                            hideStatusShowContainer('docx-container');
                        }).catch(function (error) {
                            console.error('Word é¢„è§ˆå¤±è´¥:', error);
                            showFallback();
                        });

                    } else if (previewType === 'excel') {
                        const container = document.getElementById('excel-container');
                        if (!container) {
                            throw new Error('é¢„è§ˆå®¹å™¨ä¸å­˜åœ¨');
                        }

                        try {
                            const workbook = window.XLSX.read(buffer, {
                                type: 'array',
                                cellFormula: false,
                                cellHTML: false
                            });

                            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                throw new Error('Excel æ–‡ä»¶æ²¡æœ‰å·¥ä½œè¡¨');
                            }

                            container.innerHTML = '';
                            let hasValidSheet = false;

                            workbook.SheetNames.forEach(function (name, index) {
                                try {
                                    const sheet = workbook.Sheets[name];
                                    if (sheet) {
                                        const html = window.XLSX.utils.sheet_to_html(sheet, {
                                            header: '<h4>å·¥ä½œè¡¨ ' + (index + 1) + ': ' + name + '</h4>',
                                            editable: false
                                        });

                                        if (html && html.trim().length > 0) {
                                            const section = document.createElement('section');
                                            section.innerHTML = html;
                                            container.appendChild(section);
                                            hasValidSheet = true;
                                        }
                                    }
                                } catch (sheetError) {
                                    console.warn('å¤„ç†å·¥ä½œè¡¨å¤±è´¥:', name, sheetError);
                                }
                            });

                            if (hasValidSheet) {
                                hideStatusShowContainer('excel-container');
                            } else {
                                throw new Error('æ— æ³•è¯»å– Excel å·¥ä½œè¡¨å†…å®¹');
                            }
                        } catch (excelError) {
                            console.error('Excel è§£æå¤±è´¥:', excelError);
                            throw excelError;
                        }

                    } else if (previewType === 'powerpoint') {
                        const container = document.getElementById('ppt-container');
                        if (!container) {
                            throw new Error('é¢„è§ˆå®¹å™¨ä¸å­˜åœ¨');
                        }

                        const blob = new Blob([buffer], {
                            type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                        });
                        const url = URL.createObjectURL(blob);

                        window.PPTX.load(url, '#ppt-container').then(function () {
                            hideStatusShowContainer('ppt-container');
                            URL.revokeObjectURL(url);
                        }).catch(function (error) {
                            console.error('PowerPoint é¢„è§ˆå¤±è´¥:', error);
                            URL.revokeObjectURL(url);
                            showFallback();
                        });
                    }
                } catch (renderError) {
                    console.error('æ–‡æ¡£æ¸²æŸ“å¤±è´¥:', renderError);
                    showFallback();
                }
            })
            .catch(function (error) {
                console.error('Office æ–‡æ¡£åŠ è½½å¤±è´¥:', error);
                showFallback();
            });
    } else if (clientRenderOffice) {
        // å¦‚æœéœ€è¦Officeé¢„è§ˆä½†æ²¡æœ‰rawUrlï¼Œç›´æ¥æ˜¾ç¤ºé™çº§ç•Œé¢
        showFallback();
    }
</script>
</body>
</html>
