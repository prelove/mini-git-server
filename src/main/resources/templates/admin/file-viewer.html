<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${fileName != null ? fileName : 'File Preview'} + ' - Mini Git Server'">File Preview - Mini Git Server</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pptxjs@2.12.0/dist/pptxjs.min.css">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #2c3e50;
        }
        .header {
            background: #2c3e50;
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header a {
            color: #fff;
            text-decoration: none;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem 3rem;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 1.75rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .card h2 {
            margin-top: 0;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 0.5rem 1rem;
        }
        .info-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        .info-value {
            font-weight: 600;
            word-break: break-all;
        }
        .actions {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: #3498db;
            color: #fff;
            padding: 0.6rem 1.3rem;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .btn.secondary {
            background: #95a5a6;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.secondary:hover {
            background: #7f8c8d;
        }
        .preview-card {
            min-height: 360px;
        }
        pre {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.95rem;
            line-height: 1.55;
        }
        .code-block {
            font-family: "Fira Code", "Consolas", "Monaco", monospace;
        }
        .markdown-body {
            font-size: 1rem;
            line-height: 1.7;
        }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 0.35rem;
        }
        .markdown-body pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }
        .preview-placeholder {
            text-align: center;
            color: #7f8c8d;
            padding: 2rem 1rem;
        }
        .image-preview {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .pdf-frame {
            width: 100%;
            height: 80vh;
            border: none;
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px #ecf0f1;
        }
        .docx-wrapper {
            background: #ffffff;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: inset 0 0 0 1px #e0e6ed;
        }
        .excel-container {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .excel-container table {
            border-collapse: collapse;
            width: 100%;
        }
        .excel-container th,
        .excel-container td {
            border: 1px solid #d0d7de;
            padding: 0.45rem 0.6rem;
            font-size: 0.9rem;
        }
        .excel-container th {
            background: #f4f6f8;
        }
        .alert {
            margin-top: 1rem;
            background: #fff6d5;
            color: #856404;
            padding: 0.85rem 1rem;
            border-radius: 6px;
            border: 1px solid #ffe9a8;
        }
        .preview-meta {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .office-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 260px;
            color: #7f8c8d;
            font-size: 1rem;
        }
        .office-hint {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }
    </style>
</head>
<body>
<header class="header">
    <div>
        <span>üìÅ</span>
        <span th:text="${repoName}">repository.git</span>
    </div>
    <div>
        <a th:if="${backUrl != null}" th:href="${backUrl}" class="back-link">‚Üê Back to Repository</a>
    </div>
</header>

<div class="container">
    <div class="card">
        <h2>üìÑ <span th:text="${fileName}">Filename</span></h2>
        <div class="info-grid">
            <div class="info-label">Branch</div>
            <div class="info-value" th:text="${branch != null ? branch : 'Default branch'}">main</div>
            <div class="info-label">Path</div>
            <div class="info-value" th:text="${filePath}">README.md</div>
            <div class="info-label">Size</div>
            <div class="info-value" th:text="${fileSizeFormatted}">1.2 KB</div>
            <div class="info-label">Type</div>
            <div class="info-value" th:text="${previewType}">text</div>
        </div>
        <div class="actions">
            <a th:href="${downloadUrl}" class="btn">‚¨áÔ∏è Download File</a>
            <a th:href="${rawUrl}" class="btn secondary" target="_blank" rel="noopener">View Raw Content</a>
        </div>
        <div class="preview-meta" th:if="${tooLargeForInline}">Note: The file exceeds 1 MB, inline rendering is disabled. Please download or view raw content.</div>
        <div class="preview-meta" th:if="${binaryDetected}">Note: The file contains binary content and cannot be rendered as text.</div>
    </div>

    <div class="card preview-card">
        <div th:if="${previewAvailable}">
            <div th:if="${inlinePreview}" th:switch="${previewType}">
                <div th:case="'text'">
                    <pre><code th:class="${highlightLanguage != null} ? 'code-block hljs ' + highlightLanguage : 'code-block hljs'" th:text="${textContent}"></code></pre>
                </div>
                <div th:case="'markdown'">
                    <article class="markdown-body" th:utext="${markdownHtml}"></article>
                </div>
                <div th:case="'image'" style="text-align:center;">
                    <img th:src="${imageData}" alt="image preview" class="image-preview"/>
                </div>
                <div th:case="'pdf'">
                    <iframe th:src="${pdfData}" class="pdf-frame"></iframe>
                </div>
                <div th:case="*">
                    <div class="preview-placeholder">Inline preview is not supported for this file type. Please download it.</div>
                </div>
            </div>

            <div th:if="${clientRenderOffice}">
                <div id="office-status" class="office-progress">Loading Office document preview...</div>
                <div th:if="${previewType == 'word'}" id="docx-container" class="docx-wrapper" style="display:none;"></div>
                <div th:if="${previewType == 'excel'}" id="excel-container" class="excel-container" style="display:none;"></div>
                <div th:if="${previewType == 'powerpoint'}" id="ppt-container" class="docx-wrapper" style="display:none;"></div>

                <!-- Fallback preview options -->
                <div id="office-fallback" style="display:none;" class="preview-placeholder">
                    <h3>üìÑ Office Document Info</h3>
                    <p th:text="'Filename: ' + ${fileName}">Filename</p>
                    <p th:text="'File size: ' + ${fileSizeFormatted}">File size</p>
                    <p th:text="'File type: ' + ${previewType}">File type</p>
                    <div class="alert" style="margin-top: 1.5rem;">
                        <p><strong>üí° Preview tips:</strong></p>
                        <p>‚Ä¢ Office documents are best opened with dedicated software.</p>
                        <p>‚Ä¢ Download and open with Microsoft Office or WPS Office.</p>
                        <p>‚Ä¢ For Excel files, Google Sheets is another option.</p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <a th:href="${downloadUrl}" class="btn" style="display: inline-block;">üì• Download now</a>
                        <a th:href="${rawUrl}" class="btn secondary" style="display: inline-block; margin-left: 0.5rem;" target="_blank">üîç View raw file</a>
                    </div>
                </div>

                <div class="office-hint">If preview fails, the system will switch to download mode.</div>
            </div>
        </div>
        <div th:if="${!previewAvailable}" class="preview-placeholder">
            <p>Online preview is not supported for this file type.</p>
            <p>You can still download or view the raw content using the buttons above.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxjs@2.12.0/dist/pptxjs.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('pre code').forEach(function (block) {
            if (window.hljs) {
                window.hljs.highlightElement(block);
            }
        });
    });

    const clientRenderOffice = /*[[${clientRenderOffice}]]*/ false;
    const rawUrl = /*[[${rawUrl}]]*/ '';
    const previewType = /*[[${previewType}]]*/ 'binary';

    function showFallback() {
        const statusEl = document.getElementById('office-status');
        const fallbackEl = document.getElementById('office-fallback');
        if (statusEl) statusEl.style.display = 'none';
        if (fallbackEl) fallbackEl.style.display = 'block';
    }

    function hideStatusShowContainer(containerId) {
        const statusEl = document.getElementById('office-status');
        const containerEl = document.getElementById(containerId);
        if (statusEl) statusEl.style.display = 'none';
        if (containerEl) containerEl.style.display = 'block';
    }

    if (clientRenderOffice && rawUrl) {
        // Check that required libraries are loaded.
        let libraryCheckPassed = false;
        if (previewType === 'word' && window.docx && typeof window.docx.renderAsync === 'function') {
            libraryCheckPassed = true;
        } else if (previewType === 'excel' && window.XLSX && typeof window.XLSX.read === 'function') {
            libraryCheckPassed = true;
        } else if (previewType === 'powerpoint' && window.PPTX && typeof window.PPTX.load === 'function') {
            libraryCheckPassed = true;
        }

        if (!libraryCheckPassed) {
            console.warn('Office preview libraries failed to load. Switching to fallback mode.');
            showFallback();
            return;
        }

        fetch(rawUrl)
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': Failed to load file');
                }
                return response.arrayBuffer();
            })
            .then(function (buffer) {
                if (!buffer || buffer.byteLength === 0) {
                    throw new Error('File content is empty');
                }

                try {
                    if (previewType === 'word') {
                        const container = document.getElementById('docx-container');
                        if (!container) {
                            throw new Error('Preview container not found');
                        }

                        window.docx.renderAsync(buffer, container, null, {
                            debug: false,
                            experimental: true
                        }).then(function () {
                            hideStatusShowContainer('docx-container');
                        }).catch(function (error) {
                            console.error('Word preview failed:', error);
                            showFallback();
                        });

                    } else if (previewType === 'excel') {
                        const container = document.getElementById('excel-container');
                        if (!container) {
                            throw new Error('Preview container not found');
                        }

                        try {
                            const workbook = window.XLSX.read(buffer, {
                                type: 'array',
                                cellFormula: false,
                                cellHTML: false
                            });

                            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                throw new Error('The Excel file has no sheets');
                            }

                            container.innerHTML = '';
                            let hasValidSheet = false;

                            workbook.SheetNames.forEach(function (name, index) {
                                try {
                                    const sheet = workbook.Sheets[name];
                                    if (sheet) {
                                        const html = window.XLSX.utils.sheet_to_html(sheet, {
                                            header: '<h4>Sheet ' + (index + 1) + ': ' + name + '</h4>',
                                            editable: false
                                        });

                                        if (html && html.trim().length > 0) {
                                            const section = document.createElement('section');
                                            section.innerHTML = html;
                                            container.appendChild(section);
                                            hasValidSheet = true;
                                        }
                                    }
                                } catch (sheetError) {
                                    console.warn('Failed to process worksheet:', name, sheetError);
                                }
                            });

                            if (hasValidSheet) {
                                hideStatusShowContainer('excel-container');
                            } else {
                                throw new Error('Unable to read Excel sheet content');
                            }
                        } catch (excelError) {
                            console.error('Excel parse failed:', excelError);
                            throw excelError;
                        }

                    } else if (previewType === 'powerpoint') {
                        const container = document.getElementById('ppt-container');
                        if (!container) {
                            throw new Error('Preview container not found');
                        }

                        const blob = new Blob([buffer], {
                            type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                        });
                        const url = URL.createObjectURL(blob);

                        window.PPTX.load(url, '#ppt-container').then(function () {
                            hideStatusShowContainer('ppt-container');
                            URL.revokeObjectURL(url);
                        }).catch(function (error) {
                            console.error('PowerPoint preview failed:', error);
                            URL.revokeObjectURL(url);
                            showFallback();
                        });
                    }
                } catch (renderError) {
                    console.error('Document render failed:', renderError);
                    showFallback();
                }
            })
            .catch(function (error) {
                console.error('Failed to load Office document:', error);
                showFallback();
            });
    } else if (clientRenderOffice) {
        // When Office preview is required but rawUrl is missing, show fallback directly.
        showFallback();
    }
</script>
</body>
</html>
